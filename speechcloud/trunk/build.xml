<?xml version="1.0" encoding="UTF-8"?>

<project name="speechcloud" basedir="." default="help" xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<property environment="env" />

	<property file="${basedir}/${user.name}.properties" />
    <property file="${user.home}/build.properties" />
    <property file="${basedir}/build.properties" />

	<property name="build.home" value="${basedir}/target/build" />
	<property name="build.classes.home" value="${build.home}/classes" />
	<property name="build.client.classes.home" value="${build.home}/client/classes" />
	<property name="build.cli.classes.home" value="${build.home}/cli/classes" />
	<property name="build.generated.home" value="${build.home}/gen" />
	<property name="build.war.home" value="${build.home}/war" />
	<property name="name" value="${ant.project.name}" />
	<property name="war.filename" value="${name}.war" />
	
	<property name="schema.name" value="${name}.sql" />
	<property name="sql.dir" value="${basedir}/sql" />
	
	<property name="lib.dir" value="${basedir}/lib" />
	
    <path id="maven-ant-tasks.classpath" path="${lib.dir}/maven-ant-tasks-2.1.0.jar" />
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
           uri="antlib:org.apache.maven.artifact.ant"
           classpathref="maven-ant-tasks.classpath" />	
	
	<property name="freetts.jar" value="${lib.dir}/freetts-SNAPSHOT.jar" />
	<property name="log4j.jar" value="${lib.dir}/log4j-1.2.14.jar" />
	<property name="spring.jar" value="${lib.dir}/spring-2.5.5.jar" />
	<property name="commons-pool.jar" value="${lib.dir}/commons-pool-1.3.jar" />
	<property name="commons-lang.jar" value="${lib.dir}/commons-lang-2.3.jar" />
	<property name="commons-cli.jar" value="${lib.dir}/commons-cli-1.0.jar" />
	<property name="httpmime.jar" value="${lib.dir}/httpmime-4.0.1.jar" />
	<property name="mime4j.jar" value="${lib.dir}/apache-mime4j-0.6.jar" />
	<property name="httpclient.jar" value="${lib.dir}/httpclient-4.0,1.jar" />
	<property name="httpcore.jar" value="${lib.dir}/httpcore-4.0.1.jar" />
	<property name="cairo-rtp.jar" value="${lib.dir}/cairo-rtp-SNAPSHOT.jar" />	
	<property name="tritonus_share.jar" value="${lib.dir}/tritonus_share-0.3.6.jar" />	
	<property name="sphinx4.jar" value="${lib.dir}/sphinx4.jar" />
	
	<property name="hibernate.jar" value="${lib.dir}/hibernate3.jar" />
	<property name="hsqldb.jar" value="${lib.dir}/hsqldb.jar" />
    <property name="jta.jar" value="${lib.dir}/jta-1.1.jar" />

	<property name="mary-common.jar" value="${lib.dir}/mary-common.jar" />
	
	<property name="jlibrtp.jar" value="${lib.dir}/jlibrtp.jar" />
	<property name="jdom.jar" value="${lib.dir}/jdom.jar" />
	<property name="dom4j.jar" value="${lib.dir}/dom4j-1.6.1.jar" />
	
	<property name="slf4j-api.jar" value="${lib.dir}/slf4j-api-1.5.10.jar" />
	<property name="slf4j-jcl.jar" value="${lib.dir}/slf4j-jcl-1.5.10.jar" />

    <property name="servlet-api.jar" value="${catalina.home}/lib/servlet-api.jar" />
	<property name="commons-logging.jar" value="${lib.dir}/commons-logging.jar" />
	<property name="commons-fileupload.jar" value="${lib.dir}/commons-fileupload-1.2.1.jar" />
	<property name="commons-io.jar" value="${lib.dir}/commons-io-1.4.jar" />
	<property name="jstl.jar" value="${catalina.home}/webapps/examples/WEB-INF/lib/jstl.jar" />
	<property name="standard.jar" value="${catalina.home}/webapps/examples/WEB-INF/lib/standard.jar" />
	
	
    <property name="xuggle-xuggler.jar" value="${lib.dir}/xuggle-xuggler.jar" />
	
	<property name="verbose" value="true" />

	<property name="appserver.home" value="C:/thirdparty/apache-tomcat-6.0.14" />
	<property name="appserver.lib" value="${appserver.home}/lib" />
	<property name="deploy.path" value="${appserver.home}/webapps" />
	<property name="tomcat.manager.url" value="http://localhost:8090/manager" />
	<property name="tomcat.manager.username" value="tomcat" />
	<property name="tomcat.manager.password" value="s3cret" />

	<property name="pkg.server" value="com.spokentech.speechdown.server" />
	<property name="server.wsdl.location" value="${basedir}/etc/"/>
	<property name="server.binding.files" value="customfile-server.xml"/>

	<path id="toolslib">
	 <path location="lib/hibernate-tools.jar" />
	 <path location="lib/hibernate3.jar" />
	 <path location="lib/freemarker.jar" />
	 <path location="${jdbc.driver.jar}" />
	</path>

	
	<path id="hib.classpath">
		<pathelement location="${java.home}/../lib/tools.jar" />
		<pathelement	location="${hibernate.jar}" />
		<pathelement	location="${dom4j.jar}" />
		<pathelement	location="${slf4j-api.jar}" />
		<pathelement	location="${slf4j-jcl.jar}" />
		<pathelement	location="${commons-logging.jar}" />
		 <pathelement  location="lib/hibernate-tools.jar" />
		 <pathelement location="lib/hibernate3.jar" />
		 <pathelement location="lib/freemarker.jar" />
		 <pathelement location="${jdbc.driver.jar}" />
	</path>
	
	<path id="jaxws.classpath">
		<pathelement location="${java.home}/../lib/tools.jar" />
		<pathelement	location="${commons-pool.jar}" />
		<pathelement	location="${commons-lang.jar}" />
		<pathelement	location="${commons-cli.jar}" />
		<pathelement	location="${log4j.jar}" />
		<pathelement	location="${spring.jar}" />
		<pathelement	location="${freetts.jar}" />
		<pathelement	location="${sphinx4.jar}" />
		<pathelement	location="${cairo-rtp.jar}" />
		
		<pathelement	location="${servlet-api.jar}" />
		<pathelement	location="${commons-fileupload.jar}" />
		<pathelement	location="${commons-io.jar}" />
		<pathelement	location="${httpmime.jar}" />
		<pathelement	location="${mime4j.jar}" />
		<pathelement	location="${tritonus_share.jar}" />
		<pathelement	location="${httpclient.jar}" />
		<pathelement	location="${httpcore.jar}" />
		
		<pathelement	location="${hibernate.jar}" />
		<!--pathelement	location="${jstl.jar}" /-->
	    <!--pathelement	location="${standard.jar}" /-->
	    
		<pathelement	location="${mary-common.jar}" />
		<pathelement	location="${jlibrtp.jar}" />
		<pathelement	location="${jdom.jar}" />

		<pathelement	location="${xuggle-xuggler.jar}" />
		
		
		<fileset dir="${jaxws.home}/lib">
			<include name="*.jar" />
			<exclude name="j2ee.jar" />
		</fileset>
	</path>


	<path id="speechcloud.client.classpath">
		<pathelement location="${java.home}/../lib/tools.jar" />
		<pathelement	location="${commons-pool.jar}" />
		<pathelement	location="${commons-lang.jar}" />
		<pathelement	location="${cairo-rtp.jar}" />
		
		<pathelement	location="${httpmime.jar}" />
		<pathelement	location="${mime4j.jar}" />
		<pathelement	location="${httpclient.jar}" />
		<pathelement	location="${httpcore.jar}" />
	</path>
	
	
	

    <artifact:dependencies pathId="rest.dependency.classpath">
      <dependency groupId="com.sun.jersey" 
              artifactId="jersey-server"
              version="1.1.5"/>
      
      <!--dependency groupId="com.sun.grizzly" 
              artifactId="grizzly-servlet-webserver"
              version="1.8.6.4"/>
      <artifact:remoteRepository id="maven2-repository.dev.java.net"
                             url="http://download.java.net/maven/2/" />
      <artifact:remoteRepository id="maven-repository.dev.java.net"
                             url="http://download.java.net/maven/1" 
                             layout="legacy" /-->
    </artifact:dependencies>
      <artifact:dependencies filesetId="rest.dependency.fileset"
                             useScope="runtime"
                             versionsId="dependency.versions">
          <dependency groupId="com.sun.jersey" 
              artifactId="jersey-server"
              version="1.1.5"/>
         <dependency groupId="com.sun.jersey" 
              artifactId="jersey-spring"
              version="1.0"/>
      <artifact:remoteRepository id="maven2-repository.dev.java.net"
                             url="http://download.java.net/maven/2/" />
      <artifact:remoteRepository id="maven-repository.dev.java.net"
                             url="http://download.java.net/maven/1" 
                             layout="legacy" />
    </artifact:dependencies>

	

	<taskdef name="apt" classname="com.sun.tools.ws.ant.Apt">
		<classpath refid="jaxws.classpath" />
	</taskdef>
	
	<taskdef name="wsimport" classname="com.sun.tools.ws.ant.WsImport">
		<classpath refid="jaxws.classpath" />
	</taskdef>

	<target name="setup">
		<mkdir dir="${build.home}" />
		<mkdir dir="${build.classes.home}" />
		<mkdir dir="${build.client.classes.home}" />
		<mkdir dir="${build.generated.home}" />
		<mkdir dir="${build.war.home}/WEB-INF" />
	    <mkdir dir="${build.war.home}/lib" />
	</target>
	
	

	<target name="build-server-java" depends="setup">
		<apt
			fork="true"
			debug="true"
			verbose="${verbose}"
			destdir="${build.classes.home}"
			sourcedestdir="${build.classes.home}"
			sourcepath="${basedir}/src/java">
			<classpath>
				<path refid="jaxws.classpath" />
				<pathelement location="${basedir}/src/java" />
				<pathelement location="${build.classes.home}" />
			</classpath>
			<option key="r" value="${build.home}" />
			<source dir="${basedir}/src/java">
			<include name="**/server/ws/SpeechServiceImpl.java" />
			<!--include name="**/common/**/*.java" /-->
			</source>
		</apt>
	</target>

	<target name="clean">
		<delete dir="${build.home}" includeEmptyDirs="true" />
	</target>
	
	
	    
    <!-- ********************************************************** -->
    <!-- *                                                        * -->
    <!-- * Create the acoustic model  jar.                        * -->
    <!-- *                                                        * -->
    <!-- ********************************************************** -->
    
    <target name="jar-model"
            description="Jar the accoustic model.">
        <jar destfile="${build.war.home}/lib/${accoustic.model.name}.jar"
             basedir="${accoustic.model.dir}"
             filesonly="true"
             compress="true"/>
    </target>
	
	
	<target name="create-gae-war" depends="compile-server,jar-model">
		
		<filter token="serviceLoggingFlag" value="true" />
		<filter token="applicationContext.recognizerService.baseGrammarDir" value="c:/temp" />
		<filter token="applicationContext.recognizerService.sphinxConfigFile" value="file:///${catalina.home}/webapps/${ant.project.name}/WEB-INF/sphinx-config-2pools.xml" />
		<filter token="applicationContext.synthesizerService.prefix" value="http://${catalina.host}:${catalina.port}/${ant.project.name}/prompts/" />
		<filter token="applicationContext.synthesizerService.promptDir" value="${catalina.home}/webapps/${ant.project.name}/prompts" />
		<copy todir="${build.war.home}/WEB-INF" overwrite="true" filtering="true">
			<fileset dir="${basedir}/etc" includes="*.xml" />
		</copy>
		
		
		<copy todir="${build.war.home}/WEB-INF/lib">
           <fileset refid="rest.dependency.fileset" />
           <mapper classpathref="maven-ant-tasks.classpath"
               classname="org.apache.maven.artifact.ant.VersionMapper"
               from="${dependency.versions}" to="flatten" />
        </copy>

		
	

		<war warfile="${build.war.home}/gae-${war.filename}" webxml="${build.war.home}/WEB-INF/web.xml">

			<webinf dir="${build.war.home}/WEB-INF" includes="*.xml" />
			<zipfileset dir="etc/prompts" prefix="prompts" />
			<zipfileset dir="etc/grammar" prefix="grammar" />
			<!--zipfileset dir="etc/lm" prefix="lm" /-->
			<zipfileset dir="${basedir}/etc" prefix="WEB-INF/wsdl" includes="*.wsdl, *.xsd" />			
			<zipfileset dir="${basedir}/src/java" prefix="WEB-INF/classes" includes="**/*.hbm.xml" />
			<zipfileset dir="${basedir}/etc" prefix="WEB-INF/classes" includes="log4j.xml, hibernate.cfg.xml" />
			<classes dir="${build.classes.home}" />
			<lib dir="${basedir}/lib" />
			<lib file="${jstl.jar}" />
			<lib file="${standard.jar}" />
		    <lib file="${language.model}" />
		    <lib file="${build.war.home}/lib/${accoustic.model.name}.jar" />

			<lib dir="${build.war.home}/WEB-INF/lib" />
			
		</war>
	</target>	
	         


	<target name="create-war" depends="compile-server">
		
		<filter token="serviceLoggingFlag" value="true" />
		<filter token="applicationContext.recognizerService.baseGrammarDir" value="c:/temp" />
		<filter token="applicationContext.recognizerService.sphinxConfigFile" value="file:///${catalina.home}/webapps/${ant.project.name}/WEB-INF/sphinx-config-2pools.xml" />
		<filter token="applicationContext.synthesizerService.prefix" value="http://${catalina.host}:${catalina.port}/${ant.project.name}/prompts/" />
		<filter token="applicationContext.synthesizerService.promptDir" value="${catalina.home}/webapps/${ant.project.name}/prompts" />
		<copy todir="${build.war.home}/WEB-INF" overwrite="true" filtering="true">
			<fileset dir="${basedir}/etc" includes="*.xml" />
		</copy>
		
		<copy todir="${build.war.home}/WEB-INF/lib">
           <fileset refid="rest.dependency.fileset" />
           <mapper classpathref="maven-ant-tasks.classpath"
               classname="org.apache.maven.artifact.ant.VersionMapper"
               from="${dependency.versions}" to="flatten" />
        </copy>

		
	

		<war warfile="${build.war.home}/${war.filename}" webxml="${build.war.home}/WEB-INF/web.xml">

			<webinf dir="${build.war.home}/WEB-INF" includes="*.xml" />
			<zipfileset dir="etc/prompts" prefix="prompts" />
			<zipfileset dir="etc/grammar" prefix="grammar" />
			<!--zipfileset dir="etc/lm" prefix="lm" /-->
			<zipfileset dir="${basedir}/etc" prefix="WEB-INF/wsdl" includes="*.wsdl, *.xsd" />			
			<zipfileset dir="${basedir}/src/java" prefix="WEB-INF/classes" includes="**/*.hbm.xml" />
			<zipfileset dir="${basedir}/etc" prefix="WEB-INF/classes" includes="log4j.xml, hibernate.cfg.xml" />
			<classes dir="${build.classes.home}" />
			<lib dir="${basedir}/lib" />
			<lib file="${jstl.jar}" />
			<lib file="${standard.jar}" />
			<lib dir="${build.war.home}/WEB-INF/lib" />
			
		</war>
	</target>

	<target name="generate-client" depends="setup">
		<wsimport
				debug="true"
				verbose="${verbose}"
				keep="true"
				destdir="${build.client.classes.home}"
	            sourcedestdir="${build.generated.home}"
				package="com.spokentech.speechdown.client"
				wsdl="file:///${server.wsdl.location}/speechlink.wsdl">

		</wsimport>
	    <wsimport
				debug="true"
				verbose="${verbose}"
				keep="true"
     	        sourcedestdir="${build.generated.home}"
				destdir="${build.client.classes.home}"
				package="com.spokentech.speechdown.client"
				wsdl="file:///${server.wsdl.location}/speechattach.wsdl">

		</wsimport>
	</target>
	<!--wsdl="http://${catalina.host}:${catalina.port}/${ant.project.name}/speechattach?wsdl"-->
	<!--wsdl="http://${catalina.host}:${catalina.port}/${ant.project.name}/speechlink?wsdl"-->
				
	<target name="client" depends="generate-client">
		<javac
				fork="true"
				srcdir="${basedir}/src/java"
				destdir="${build.client.classes.home}"
				debug="on"
                debuglevel="lines,vars,source" 
				includes="**/client/**,**/common/**">
			<classpath refid="jaxws.classpath" />
		</javac>
	</target>

    <target name="compile-client">
      <echo message="compile-client" />
      <javac srcdir="src/java"
        destdir="${build.classes.home}"
        classpathref="speechcloud.client.classpath"
        includes="client/**, common/**"
        debug="on"
        debuglevel="lines,vars,source" 
        failonerror="true"/>
    </target>


	<target name="run">
		<java fork="true" classname="com.spokentech.speechdown.client.SpeechServiceClient">
			<classpath>
				<path refid="jaxws.classpath" />
				<pathelement location="${build.client.classes.home}" />
				<pathelement location="${basedir}/etc" />
			</classpath>
		</java>
	</target>
	
   <target name="jar-client" depends="client">
        <jar destfile="${basedir}/lib//speechcloud-client.jar"
             basedir="${build.client.classes.home}"
             filesonly="true"
             compress="true"/>
    </target>

	<target name="deploy">
		<copy file="${build.war.home}/${war.filename}" todir="${catalina.home}/webapps" />
	</target>

	<target name="server" depends="clean, deploy" />


    <target name="import-wsdl-server" depends="setup"> 
      <antcall target="do-wsdl2java">
        <param name="pkg" value="${pkg.server}"/>
        <param name="wsdl.location" value="${server.wsdl.location}"/>
        <param name="wsdl.file" value="${server.wsdl.location}/SpeechAttach.wsdl"/>
        <param name="customization.binding.files" value="${server.binding.files}"/>
      </antcall>
      <antcall target="do-wsdl2java">
        <param name="pkg" value="${pkg.server}"/>
        <param name="wsdl.location" value="${server.wsdl.location}"/>
        <param name="wsdl.file" value="${server.wsdl.location}/SpeechLink.wsdl"/>
        <param name="customization.binding.files" value="${server.binding.files}"/>
      </antcall>
    </target>
    
    <target name="compile-server" depends="import-wsdl-server">
      <echo message="compile-server" />


      <javac srcdir="${basedir}/src/java"
        destdir="${build.classes.home}"
        includes="**/server/**, **/common/**"
        debug="on"
        failonerror="true">
        <classpath>
        		<path refid="jaxws.classpath" />
        		<path refid="rest.dependency.classpath" />
				<pathelement location="${build.classes.home}" />
		</classpath>
	   </javac>
    </target>
    
    
    <target name="import-wsdl-client">
      <antcall target="do-wsdl2java">
        <param name="pkg" value="${pkg.client}"/>
        <param name="wsdl.location" value="${client.wsdl.location}"/>
        <param name="sourcedestdir" value="${build.generated.home}"/>
<!--        <param name="wsdl.file" value="${client.wsdl.location}"/> -->
        <param name="customization.binding.files" value="${client.binding.files}"/>
      </antcall>
    </target>
    
    

    <!-- generates portable artifacts WSDL-to-Java (wsimport) -->
    <!-- uses binding customizations to specify where artifacts go -->
    <target name="do-wsdl2java">
           <echo message="Invoking WsImport task (WSDL-to-Java mapping)" />
           <wsimport 
              fork="true"
              package="${pkg}"
              verbose="${verbose}"
              debug="${wsimport.debug}"
              destdir="${build.classes.home}"
              sourcedestdir="${build.generated.home}"
              keep="true"
              wsdllocation="${wsdl.location}"
              wsdl="${wsdl.file}">
              <binding dir="." includes="${customization.binding.files}"/>
           </wsimport>
    </target> 
    

    

    

	<!-- ============================================================== -->
	<!-- Tomcat tasks - remove these if you don't have Tomcat installed -->
	<!-- ============================================================== -->
	<path id="catalina-ant-classpath">
		<!-- We need the Catalina jars for Tomcat -->
		<!-- * for other app servers - check the docs -->
		<fileset dir="${appserver.lib}">
			<include name="catalina-ant.jar" />
		</fileset>
	</path>
	<taskdef name="install" classname="org.apache.catalina.ant.InstallTask">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>
	<taskdef name="reload" classname="org.apache.catalina.ant.ReloadTask">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>
	<taskdef name="list" classname="org.apache.catalina.ant.ListTask">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>
	<taskdef name="start" classname="org.apache.catalina.ant.StartTask">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>
	<taskdef name="stop" classname="org.apache.catalina.ant.StopTask">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>
	<target name="install" description="Install application in Tomcat">
		<install url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}" path="/${name}" war="${name}" />
	</target>
	<target name="reload" description="Reload application in Tomcat">
		<reload url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}" path="/${name}" />
	</target>
	<target name="start" description="Start Tomcat application">
		<start url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}" path="/${name}" />
	</target>
	<target name="stop" description="Stop Tomcat application">
		<stop url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}" path="/${name}" />
	</target>
	<target name="list" description="List Tomcat applications">
		<list url="${tomcat.manager.url}" username="${tomcat.manager.username}" password="${tomcat.manager.password}" />
	</target>
	<!-- End Tomcat tasks -->

	<target name="schemaexport">
	    <taskdef name="schemaexport"
	        classname="org.hibernate.tool.hbm2ddl.SchemaExportTask"
	        classpathref="hib.classpath"/>
	    <schemaexport
	    	config="${basedir}/etc/hibernate.cfg.xml" 
	        quiet="no"
	        text="no"
	        drop="no"
	        delimiter=";"
	        output="schema-export.sql">
	    	<fileset dir="${dir.classes}" includes="**/*.hbm.xml"/>
	    </schemaexport>
	</target>
	
	<target name="sal">
		<taskdef name="hibernatetool"
		                classname="org.hibernate.tool.ant.HibernateToolTask"
		                classpathref="hib.classpath"/>
	
	
	    <hibernatetool destdir="${sql.dir}">
		 <classpath>
	        <path location="${classes.dir}"/>
		 </classpath>
	     <configuration configurationfile="${basedir}/etc/hibernate.cfg.xml" />
		 <hbm2ddl export="false" outputfilename="${schema.name}.sql"/>
	
		</hibernatetool>
	</target>
	
	
	
	<target name="help">
		<echo message="server:				Builds and deploys the service endpoint WAR" />
		<echo message="client:				Builds the client" />
		<echo message="run:					Runs the client" />
	</target>

</project>
